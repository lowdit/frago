{{/* Build a map with all accessibility score for using it later in code :: maybe for catching progression or regression */}}
{{ $scorekey      := sha1 (string now) }}
{{ $path := "" }}{{ with .File }}{{ $path = .Path }}{{ end }}
{{ $data          := newScratch }}
{{ $time          := now.UnixMilli }}
{{ $reflist       := (slice "accessibility" "raweb" "ecoconception" "opquast" "publishing") }}

{{/* Declare Var */}}
{{ $data.Delete "allscores" }}
{{ range $reflist }}
  {{ $data.Set (printf "%s-list-t" .) slice }}
  {{ $data.Set (printf "aggregate-%s-version" .) slice }}
  {{ $data.Set (printf "aggregate-%s-context" .) slice }}
  {{ $data.Set (printf "aggregate-%s-list" .) slice }}
  {{ $data.Set (printf "aggregate-%s-nc" .) slice }}
  {{ $data.Set (printf "aggregate-%s-c" .) slice }}
  {{ $data.Set (printf "aggregate-%s-sum" .) 0 }}
{{ end }}
{{ $data.Set "aggregate-performance-list" slice }}
{{ $data.Set "aggregate-performance-sum" 0 }}

{{/* START Loop all audits */}}
{{ range $pageid, $value := sort .pages ".Title" "desc" }}
  {{ $timepartial   := now.UnixMilli }}
  {{ $project       := partialCached "render/projectpath" . . }}
  {{ if ne $project "" }}
  {{ $context := . }}
  {{ $ref  := $context.Site.Data.referential }}
  {{ $path := "" }}{{ with .File }}{{ $path = .Path }}{{ end }}
  {{/* START Only page in audits folder */}}
  {{ if and (in (path.Base $path) "index.md") (not (in "audits/_index.md" $path)) (ne (len (split $path "/")) 4) }}
    {{/* START Loop over each referential :: calculate */}}
    {{ range $reflist }}
      {{ $type    := . }}
      {{ $data.Set (printf "average-%s-pourcentage" $type) (dict
        "pourcentage"              ""
        "pourcentage100"           ""
        "pourcentage80"            ""
        "pourcentage50"            ""
        "pourcentage30"            ""
        "pourcentage00"            ""
      )}}
      {{ $auditsfiles := (partial "render/lastfile.html" (dict "context" . "project" $project "type" $type) . $project $type) }}
      {{ with (index $auditsfiles "auditfile-all-path") }}
      {{ if (not (in . "false")) }}
        {{ range $id, $file := last 1 (sort .) }}
          {{/* Calculate the score for a referential */}}
          {{/* Call context  */}}
          {{ $data.Set (printf "aggregate-%s-contextaudit" $type) (partialCached "render/context.html" (dict "context" $context "project" $project "type" $type) $project $type) }}

          {{/* Variables  */}}
          {{ $guidelines   := ((index ($data.Get (printf "aggregate-%s-contextaudit" $type)) (index $auditsfiles "auditfile-name")).guidelines) }}
          {{/* Determine the audit version :: switch to RGAA 4 if RAweb 1 */}}
          {{ $versionlong := (cond (and (eq $guidelines.name "raweb") (eq $type "accessibility")) "4.1" $guidelines.version ) }}
          {{ $version     := $guidelines.versionmajor }}
          {{ $data.Add (printf "aggregate-%s-version" $type) $version }}

          {{/* Store each result in a map */}}
          {{ $render       := (partialCached (printf "render/%s.html" (cond (eq $type "raweb") "accessibility" $type )) (dict "context" "aggregate" "auditfile" . "referential" $guidelines "auditname" (index ($data.Get (printf "aggregate-%s-contextaudit" $type) ) (index $auditsfiles "auditfile-name")).guidelines.name) . (index ($data.Get (printf "aggregate-%s-contextaudit" $type)) (index $auditsfiles "auditfile-name")).guidelines.name $type) }}
          {{ $data.SetInMap $project $type $render }}

          {{/* START Count the sum for each criteria */}}
          {{ if $render.criteria }}
          {{ range $ids, $valuekey := (slice "conforme" "nonconforme" "nonapplicable") }}

              {{/* START Loop conforme criteria */}}
              {{ range $id, $value := index $render.criteria $valuekey }}
                {{ $data.Add (printf "%s%s-%s" $id $type $valuekey) 1 }}
                {{ $data.Add (printf "%s%s-%s-%s" $id $type $version $valuekey) 1 }}
                {{ $data.SetInMap (printf "average-%s-%s" $type $valuekey) (string $id) ($data.Get (printf "%s%s-%s" $id $type $valuekey)) }}
                {{ $data.SetInMap (printf "average-%s-%s-%s" $type $valuekey $version) (string $id) ($data.Get (printf "%s%s-%s-%s" $id $type $version $valuekey)) }}
                {{ $thematique := "" }}
                {{ with (in $id ".") }}
                  {{ $thematique = (index (index $ref $type).topics (sub (int (delimit (first 1 (split $id ".")) "")) 1)) }}
                {{ else }}
                  {{ $referential    := (partialCached "render/referential-version.html" (dict "context" $context "referential" "opquast") $context "opquast").guideline }}
                  {{ $criteriafile   := (index (index $context.Site.Data $referential.name) (string $referential.version)).criteria.criteres }}
                  {{ $thematique      = (index (index (where $criteriafile "number" (float $id)) 0).thema 0).fr }}
                {{ end }}
                {{ $data.Add (printf "%s%s-%s-t" $thematique $type $valuekey) 1 }}
                {{ $data.Add (printf "%s%s-%s-%-t" $thematique $type $valuekey $version) 1 }}
                {{ $data.Add (printf "%s-list-t" $type) $thematique }}
                {{ $data.Add (printf "%s-%s-list-t" $type $version) (printf ",%s" $thematique) }}
                {{/* Store conforme criteria */}}
                {{ $data.SetInMap (printf "average-%s-%s-t" $type $valuekey) (string $thematique) ($data.Get (printf "%s%s-%s-t" $thematique $type $valuekey)) }}
                {{ $data.SetInMap (printf "average-%s-%s-%s-t" $type $valuekey $version) (string $thematique) ($data.Get (printf "%s%s-%s-%-t" $thematique $type $valuekey $version)) }}
              {{ end }}
              {{/* END Loop conforme criteria */}}
            {{ end }}

            {{/* START Loop all criteria :: one more time for filling map for percentage */}}
            {{ range $id, $value := $render.criteria.all }}
              {{/* WARNING "average-%s-nonconforme" can have a nil value */}}
              {{ with not ($data.Get (printf "average-%s-nonconforme" $type)) }}
                {{ $data.SetInMap (printf "average-%s-nonconforme" $type) (string $id) 0 }}
              {{ end }}
            {{ end }}
            {{/* END Loop all criteria */}}

            {{ $data.Set (printf "average-%s-pourcentage"   $type)          (partialCached "render/aggregate-pourcentage-criteria" (dict "value" $render.criteria.all "conforme" ($data.Get (printf "average-%s-conforme" $type)) "nonconforme" ($data.Get (printf "average-%s-nonconforme" $type)) "nonapplicable" ($data.Get (printf "average-%s-nonapplicable" $type))) $render.criteria.all "1") }}
            {{ $data.Set (printf "average-%s-pourcentage-%" $type $version) (partialCached "render/aggregate-pourcentage-criteria" (dict "value" $render.criteria.all "conforme" ($data.Get (printf "average-%s-conforme-%s" $type $version)) "nonconforme" ($data.Get (printf "average-%s-nonconforme-%s" $type $version)) "nonapplicable" ($data.Get (printf "average-%s-nonapplicable-%s" $type $version))) $render.criteria.all "2") }}
          {{ end }}
          {{/* END Count the sum for each criteria */}}

          {{ $score       := $render.scores.compliance }}

          {{/* Fill maps with values for each ref */}}
          {{ $data.Add (printf "aggregate-%s-context" $type) $guidelines }}

          {{ $data.Add (printf "aggregate-%s-list" $type) $score }}
          {{ $data.SetInMap (printf "aggregate-%s-lists" $type) (string $project) (dict "version" $guidelines.version "score" $score) }}

          {{ $nonconforme := false }}
          {{ $conforme    := false }}
          {{ $data.Add (printf "aggregate-%s-sum" $type) $score }}
          {{ if lt $score 50 }}
            {{ $nonconforme = true }}
            {{ $data.Add (printf "aggregate-%s-nc" $type) $score }}
          {{ end }}
          {{ if eq $score 100 }}
            {{ $nonconforme = true }}
            {{ $data.Add (printf "aggregate-%s-c" $type) $score  }}
          {{ end }}

          {{ $data.SetInMap (printf "aggregate-%s-list-byaudit" $type) (string $pageid) (dict "score" $score "version" $version "versionlong" $versionlong "conforme" $conforme "nonconforme" $nonconforme) }}

        {{ end }}
      {{ end }}
      {{ end }}
    {{ end }}
    {{/* END Loop over referential :: calculate */}}

    {{/* START Loop Performance */}}
    {{ with (index (partialCached "render/lastfile.html" (dict "context" . "project" $project "type" "performance") $project "performance") "auditfile-all-path") }}
      {{ if (not (in . "false")) }}
        {{ range $id, $value := last 1 (sort .) }}
          {{ $render := (partialCached "render/performance.html" (dict "context" "aggregate" "auditfile" . ) .) }}
          {{ $data.SetInMap $project "performance" $render }}
          {{ $score := $render.ecoscore }}
          {{ $data.Add "aggregate-performance-list" $score }}
          {{ $data.Add "aggregate-performance-sum" $score }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{/* END Loop Performance */}}

    {{ if (eq (getenv "HUGO_ENV") "debugperf") }}
      {{ $data.SetInMap "debugperf" $path (string (sub now.UnixMilli $timepartial)) }}
      {{ $timepartial   = now.UnixMilli }}
    {{ end }}

  {{ end }}
  {{ $data.SetInMap "allscores" $project           ($data.Get $project) }}
  {{ end }}
{{ end }}

{{/* START Loop over referential :: adding value in a Map */}}
{{ range $id, $value := $reflist }}

  {{ $type    := . }}
  {{ $dictall := dict }}
  {{ $dict1   := dict }}
  {{ $dict2   := dict }}

  {{ $dict1 = merge (dict
    "conforme"                 ($data.Get (printf "average-%s-conforme"        $type))
    "nonconforme"              ($data.Get (printf "average-%s-nonconforme"     $type))
    "nonapplicable"            ($data.Get (printf "average-%s-nonapplicable"   $type))
    "all"                      ($data.Get (printf "average-%s-conforme"        $type))
  ) ($data.Get (printf "average-%s-pourcentage" $type)) }}

  {{ if and ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonconforme" $type)) }}
    {{ $dictall = (merge ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonconforme" $type))) }}
    {{ $dict1   = merge $dict1 (dict "all" $dictall) }}
  {{ end }}
  {{ if and ($data.Get (printf "average-%s-nonapplicable" $type)) ($data.Get (printf "average-%s-nonconforme" $type)) }}
    {{ $dictall = ((merge (merge ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonconforme" $type))) ($data.Get (printf "average-%s-nonapplicable" $type)))) }}
    {{ $dict1 = merge $dict1 (dict "all" $dictall)}}
  {{ end }}
  {{ if and ($data.Get (printf "average-%s-nonapplicable" $type)) (not (and ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonconforme" $type)))) }}
    {{ $dictall = ($data.Get (printf "average-%s-nonapplicable" $type)) }}
    {{ $dict1 = merge $dict1 (dict "all" $dictall) }}
  {{ end }}
  {{ if and ($data.Get (printf "average-%s-nonconforme" $type)) (not (and ($data.Get (printf "average-%s-conforme" $type)) ($data.Get (printf "average-%s-nonapplicable" $type)))) }}
    {{ $dictall = ($data.Get (printf "average-%s-nonconforme" $type)) }}
    {{ $dict1 = merge $dict1 (dict "all" $dictall) }}
  {{ end }}

  {{ if and ($data.Get (printf "average-%s-conforme-t" $type)) ($data.Get (printf "average-%s-nonconforme-t" $type)) }}
    {{ $dict2 = (dict
        "thematiquelist"           (uniq ($data.Get (printf "%s-list-t"            $type)))
        "thematiqueconforme"       ($data.Get (printf "average-%s-conforme-t"      $type))
        "thematiquenonconforme"    ($data.Get (printf "average-%s-nonconforme-t"   $type))
        "thematiquenonapplicable"  ($data.Get (printf "average-%s-nonapplicable-t" $type))
        "thematiquepourcentage"    (partial "render/aggregate-pourcentage-thematique" (dict "conforme" ($data.Get (printf "average-%s-conforme-t" $type)) "nonconforme" ($data.Get (printf "average-%s-nonconforme-t" $type)) "nonapplicable" ($data.Get (printf "average-%s-nonapplicable-t" $type))))
    ) }}
  {{ end }}

  {{ $data.SetInMap "average" $type   (merge $dict1 $dict2) }}

  {{/* START Score by audit ref version */}}
  {{ range (uniq ($data.Get (printf "aggregate-%s-version" $type))) }}
    {{ $dictall := dict }}
    {{ $data.Set "all" 0 }}
    {{ $data.Set "sum" 0 }}
    {{ $data.Set "version" slice }}
    {{ range (where (sort ($data.Get (printf "aggregate-%s-list-byaudit" $type))) "version" (string .)) }}
      {{ $data.Add "all" 1 }}
      {{ $data.Add "sum" .score }}
      {{ $data.Add "version" . }}
      {{ $data.SetInMap (printf "aggregate-%s-byaudit"    $type) (string .version) ($data.Get "version") }}
      {{ $map := (index ($data.Get (printf "aggregate-%s-byaudit" $type)) (string .version))}}

      {{ if and ($data.Get (printf "average-%s-conforme-%s" $type (string .version))) ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version))) }}
        {{ $dictall = (merge ($data.Get (printf "average-%s-conforme-%s" $type (string .version))) ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version)))) }}
      {{ end }}
      {{ if and ($data.Get (printf "average-%s-nonapplicable-%s" $type (string .version))) ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version))) }}
        {{ $dictall = ((merge (merge ($data.Get (printf "average-%s-conforme-%s" $type (string .version))) ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version)))) ($data.Get (printf "average-%s-nonapplicable-%s" $type (string .version))))) }}
      {{ end }}
      {{ if and ($data.Get (printf "average-%s-nonapplicable-%s" $type (string .version))) (not (and ($data.Get (printf "average-%s-conforme-%s" $type (string .version))) ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version))))) }}
        {{ $dictall = ($data.Get (printf "average-%s-nonapplicable-%s" $type (string .version))) }}
      {{ end }}
      {{ if and ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version))) (not (and ($data.Get (printf "average-%s-conforme-%s" $type (string .version))) ($data.Get (printf "average-%s-nonapplicable-%s" $type (string .version))))) }}
        {{ $dictall = ($data.Get (printf "average-%s-nonconforme-%s" $type (string .version))) }}
      {{ end }}

      {{ $data.SetInMap (printf "aggregate-%s-byauditall" $type) (string .version)
        (dict
            "average"     (div ($data.Get "sum") (len $map))
            "occurence"   ($data.Get "all")
            "number"      (len $map)
            "valid"    (len (where $map "conforme" true))
            "invalid" (len (where $map "nonconforme" true))
            "criteria" (merge (dict
              "conforme"                 ($data.Get (printf "average-%s-conforme-%s"        $type (string .version)))
              "nonconforme"              ($data.Get (printf "average-%s-nonconforme-%s"     $type (string .version)))
              "nonapplicable"            ($data.Get (printf "average-%s-nonapplicable-%s"   $type (string .version)))
              "thematiquelist"           (uniq (split (strings.TrimLeft "," ($data.Get (printf "%s-%s-list-t" $type (.version)))) ","))
              "thematiqueconforme"       ($data.Get (printf "average-%s-conforme-%s-t"      $type (string .version)))
              "thematiquenonconforme"    ($data.Get (printf "average-%s-nonconforme-%s-t"   $type (string .version)))
              "thematiquenonapplicable"  ($data.Get (printf "average-%s-nonapplicable-%s-t" $type (string .version)))
              "thematiquepourcentage"    (partial "render/aggregate-pourcentage-thematique" (dict "conforme" ($data.Get (printf "average-%s-conforme-%s-t" $type (string .version))) "nonconforme" ($data.Get (printf "average-%s-nonconforme-%s-t" $type (string .version))) "nonapplicable" ($data.Get (printf "average-%s-nonapplicable-%s-t" $type (string .version)))))
              "all"                      $dictall
            ) ($data.Get (printf "average-%s-pourcentage-%" $type (string .version))) ))
        }}
    {{ end }}
  {{ end }}

  {{/* $data.SetInMap (printf "aggregate%s" .) "context"            ($data.Get (printf "aggregate-%s-context" .)) */}}
  {{ $data.SetInMap (printf "aggregate%s" .) "all"                ($data.Get (printf "aggregate-%s-list" .)) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "occurence"          (len ($data.Get (printf "aggregate-%s-list" .))) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "invalid"            (len ($data.Get (printf "aggregate-%s-nc" .))) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "valid"              (len ($data.Get (printf "aggregate-%s-c" .))) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "sum"                ($data.Get (printf "aggregate-%s-sum" .)) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "guidelines"         ($data.Get (printf "aggregate-%s-context" .)) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "lists"              ($data.Get (printf "aggregate-%s-lists" $type)) }}
  {{ $data.SetInMap (printf "aggregate%s" .) "liste"              ($data.Get (printf "aggregate-%s-byaudit" .))  }}
  {{ $data.SetInMap (printf "aggregate%s" .) "listestats"         ($data.Get (printf "aggregate-%s-byauditall" .))  }}
  {{ $data.SetInMap (printf "aggregate%s" .) "average"            slice }}
  {{ with ($data.Get (printf "aggregate-%s-list" .)) }}
    {{ $data.SetInMap (printf "aggregate%s" $type) "average"          (div ($data.Get (printf "aggregate-%s-sum" $type)) (len .)) }}
  {{ end }}


{{ end }}
{{/* END Loop over referential :: adding value in a Map */}}

{{ $data.SetInMap "aggregateperformance" "all"                  ($data.Get "aggregate-performance-list") }}
{{ $data.SetInMap "aggregateperformance" "sum"                  ($data.Get "aggregate-performance-sum")  }}
{{ $data.SetInMap "aggregateperformance" "average"              slice }}
{{ with ($data.Get "aggregate-performance-list") }}
  {{ $data.SetInMap "aggregateperformance" "average"            (div ($data.Get "aggregate-performance-sum") (len ($data.Get "aggregate-performance-list"))) }}
{{ end }}

{{ $data.SetInMap "aggregates" "accessibility"                  ($data.Get "aggregateaccessibility") }}
{{ $data.SetInMap "aggregates" "raweb"                          ($data.Get "aggregateraweb")         }}
{{ $data.SetInMap "aggregates" "ecoconception"                  ($data.Get "aggregateecoconception") }}
{{ $data.SetInMap "aggregates" "opquast"                        ($data.Get "aggregateopquast")       }}
{{ $data.SetInMap "aggregates" "publishing"                     ($data.Get "aggregatepublishing")    }}
{{ $data.SetInMap "aggregates" "performance"                    ($data.Get "aggregateperformance")   }}
{{ $data.SetInMap "aggregates" "allscores"                      ($data.Get "allscores")              }}
{{ $data.SetInMap "aggregates" "allaverage"                     ($data.Get "average")                }}

{{ return ($data.Get "aggregates") }}

{{ if (eq (getenv "HUGO_ENV") "debugperf") }}
  {{ warnf ".." }}
  {{ warnf "Aggregates------------------------------------------------------------" }}
  {{ range $key, $value := ($data.Get "debugperf") }}
    {{ $time := . }}
    {{ warnf "=> Aggregates     Parti | %s%sms| %q" (cond (eq (len $time) 4) "" (cond (eq (len $time) 3) " " (cond (eq (len $time) 2) "  " "   "))) $time $key }}
  {{ end }}
  {{ $time := string (sub now.UnixMilli $time) }}
  {{ warnf "=> Aggregates     Total | %s%sms|" (cond (eq (len $time) 4) "" (cond (eq (len $time) 3) " " (cond (eq (len $time) 2) "  " "   "))) $time }}
{{ end }}

